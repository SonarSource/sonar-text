provider:
  metadata:
    name: Rabbit MQ
    category: Data Storage
    message: Make sure these Rabbit MQ credentials get revoked, changed, and removed from the code.

  rules:
    - rspecKey: S6736
      id: amqp-url
      metadata:
        name: AMQP URL
      detection:
        matching:
          # Type 1 pattern amqp://{username}:{password}@{host}:{port}/{path}
          pattern: "\\bamqp://(\\w+:[^@\\s]+)@[-\\w%.\\+]+\\b(?:[-\\w%.\\+()@:~#?&/=]*)"
        post:
          # Avoid matching values found on SourceGraph that look like dummy passwords or insertions like:
          # - amqp://guest:guest@example.com:8080
          # - amqp://flower:{{ rabbitmq_password }}@localhost:8080/endpoint
          # - amqp://user:password@host
          # - amqp://foo:bar@127.0.0.1:5672/"
          # - amqp://guest:**@healthy.example.com
          # - amqp://admin:#{ENV.fetch("ADMIN_PASSWORD")}@mqtt:5672
          # - amqp://admin:%s@host:5672
          # - amqp://admin:$env{admin_pwd}@host
          patternNot: 
            "(?i)\
            (\\w)\\1{3,}|\
            :guest|\
            :password|\
            user:|\
            foo|\
            bar|\
            123456|\
            \\b(get)?env(iron)?\\b|\
            \\*\\*|\
            :%s\\b|\
            :\\{\\{[^}]+}}"
      examples:
        - text: |
            const MQURL = "amqp://guest:guest@127.0.0.1:5672/"
          containsSecret: false
        - text: |
            const MQURL = "amqp://user:password@127.0.0.1:5672/"
          containsSecret: false
        - text: |
            const MQURL = "amqp://foo:bar@127.0.0.1:5672/"
          containsSecret: false
        - text: |
            const MQURL = "amqp://example:**@127.0.0.1:5672/"
          containsSecret: false
        - text: |
            const MQURL = "amqp://example:{{vaul_variable_name}}@127.0.0.1:5672/"
          containsSecret: false
        - text: |
            const MQURL = "amqp://admin:#{ENV.fetch("ADMIN_PASSWORD")}@host:5672"
          containsSecret: false
        - text: |
            const MQURL = "amqp://admin:%s@host:5672"
          containsSecret: false
        - text: |
            const MQURL = "amqp://admin:$env{admin_pwd}@host"
          containsSecret: false      
        - text: |
            const MQURL = "amqp://examplename:asd_nled9f@127.0.0.1:5672/"
          containsSecret: true
          match: examplename:asd_nled9f
        - text: |
            examples: ["amqp://bob:saleneinasldeins@127.0.0.1:5672/%2f?timeout=10"]
          containsSecret: true
          match: bob:saleneinasldeins

    
