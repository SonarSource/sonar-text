provider:
  metadata:
    name: GitLab
    category: Version Control System
    message: Make sure this GitLab token gets revoked, changed, and removed from the code.
  detection:
    pre:
      include:
        content:
          - glpat-
      reject:
        ext:
          ${common/rejectedExtensions.yaml}

  rules:
    - id: gitlab-v2-tokens
      rspecKey: S6690
      selectivity: specific # to avoid overlaps with a more general Gitlab rule S7398
      metadata:
        name: GitLab Token
      detection:
        matching:
          pattern: "\\b(glpat-(?<rand>[a-zA-Z0-9_-]{20}))\\b"
        post:
          groups:
            - name: rand
              statisticalFilter:
                threshold: 3.2 # Based on significant sampling, 3.3 < entropy < 4.3
          heuristicFilter:
            heuristics:
              - path
              - uri
      examples:
        - text: |
            // noncompliant example
            props.set("token", "glpat-zcs1FfaxGnHfvzd7ExHz")
          containsSecret: true
          match: glpat-zcs1FfaxGnHfvzd7ExHz
        - text: |
            // compliant example
            props.set("token", System.getenv("TOKEN"))
          containsSecret: false
        - text: |
            gl_token=glpat-zcs1FfaxGnHfvzd7ExHz
          containsSecret: true
          match: glpat-zcs1FfaxGnHfvzd7ExHz
        - text: |
            gl_token=glpat-aaaaaaaaaaaaaaaaaaaa
          containsSecret: false
    - id: gitlab-tokens
      rspecKey: S6690
      selectivity: specific # to avoid overlaps with a more general Gitlab rule S7398
      metadata:
        name: GitLab Token
      detection:
        matching:
          # "#{prefix}#{base64_payload}.#{token_version}.#{base64_payload_length}"
          # Based on https://github.com/gitlabhq/gitlabhq/blob/ef38c5f3c4e70a3860502911a8e5a0792a08ac42/lib/authn/token_field/generator/routable_token.rb#L73-L77
          pattern: >-
            \b(glpat-(?<rand>[a-zA-Z0-9_-]{32})\.\d{2}\.[a-z\d]{9})\b
        post:
          groups:
            - name: rand
              statisticalFilter:
                threshold: 3.5
          heuristicFilter:
            heuristics:
              - path
              - uri
      examples:
        - text: |
            glpat-iAyXzeou9NAr1CcvZULc7G86MQp1OjEH.01.0w1l5e7up
          containsSecret: true
          match: glpat-iAyXzeou9NAr1CcvZULc7G86MQp1OjEH.01.0w1l5e7up
        - text: |
            glpat-SNO6Sk1roYl9dW9UrN_GwG86MQp1OjEH.01.0w1x4p590
          containsSecret: true
          match: glpat-SNO6Sk1roYl9dW9UrN_GwG86MQp1OjEH.01.0w1x4p590
        - text: |
            glpat-r6Ky1yconRtVTQtWv7Gvk286MQp1OjEH.01.0w0jqdfjf
          containsSecret: true
          match: glpat-r6Ky1yconRtVTQtWv7Gvk286MQp1OjEH.01.0w0jqdfjf
