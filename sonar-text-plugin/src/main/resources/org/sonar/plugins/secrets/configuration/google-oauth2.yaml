provider:
  metadata:
    name: Google
    category: Miscellaneous services
    references:
      - description: Google - Setting Up OAuth 2.0
        link: https://support.google.com/googleapi/answer/6158849
        type: Documentation 
    message: Make sure this Google OAuth client secret gets revoked, changed, and removed from the code.

  detection:
    pre:
      include:
        content:
          - .apps.googleusercontent.com

  rules:
    - id: google-oauth-secret-with-prefix
      metadata:
        name: Google OAuth client secrets should not be disclosed
      detection:
        matching:
          pattern: "\\b(GOCSPX-[A-Za-z0-9_\\-]{28})\\b"
        post:
          patternNot: "(?i)sample|example|x{6}|0{6}"
      examples:
        - text: >
            GOOGLE_KEY = "573596364929-intnbplawt4tu1mrpvyijnwvdyagv9mt.apps.googleusercontent.com"
            GOOGLE_SECRET = "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"
          containsSecret: true
          match: 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
        - text: >
            GOOGLE_CLIENT_ID='sample_385938534644-ppt2daiov3qzimvmgokahsvcb96wutkj.apps.googleusercontent.com'
            GOOGLE_CLIENT_SECRET='sample_GOCSPX-fxynOF52PNXmtfq78B-lUCO0Grj1'
          containsSecret: false
        - text: >
            oauth_id: nnnnnnnnnnn-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
            oauth_secret: GOCSPX-xxxxxxxxxxxxxxxxxxxxxxxxxxxx
          containsSecret: false

    # Older tokens without a prefix are harder to detect. The token itself can detect a lot of false negatives so we
    # need to look for two values nearby: ".apps.googleusercontent.com" and "secret". Either value could appear on
    # either side of the token.
    # There's currently no way to place a distance limit on context matches so these checks need to be built into the
    # regex.
    # Research on SourceGraph shows that token -> "secret" almost never appears in the wild, although the string
    # ".apps.googleusercontent.com" does appear on either side. We can get away with 2 regexes for this instead of 4.

    - id: google-oauth-secret-no-prefix-client-id-before
      metadata:
        name: Google OAuth client secrets should not be disclosed
      detection:
        matching:
          # ".apps.googleusercontent.com"
          # any text, containing up to 3 newlines
          # "secret"
          # any text, containing up to 1 newline
          # the target client secret
          pattern: "(?i)(?:\\.apps\\.googleusercontent\\.com\\b(?:[^\\r\\n]*+\\r?\\n){0,3}?[^\\r\\n]*)(?:secret(?:[^\\r\\n]*+\\r?\\n)?[^\\r\\n]+)\\b([A-Za-z0-9_\\-]{24})\\b"
        post:
          patternNot: "(?i)sample|example|x{6}|0{6}"
          statisticalFilter:
            threshold: 4.0
      examples:
        - text: >
            client_id: 514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com
            client_secret: TgxYWFmND-1NTYwNTgzMDM3N
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            GOOGLE_ID=514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com
            GOOGLE_SECRET=TgxYWFmND-1NTYwNTgzMDM3N
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            # AUTH_OIDC_ENABLED=true
            # AUTH_OIDC_CLIENT_ID=514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com
            # AUTH_OIDC_CLIENT_SECRET=TgxYWFmND-1NTYwNTgzMDM3N
            # AUTH_OIDC_DISCOVERY_URI=https://accounts.google.com/.well-known/openid-configuration
            # AUTH_OIDC_BASE_URL=http://localhost:9000
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            {"installed":{"client_id":"514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com","project_id":"example-project-12345","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://accounts.google.com/o/oauth2/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_secret":"TgxYWFmND-1NTYwNTgzMDM3N","redirect_uris":["urn:ietf:wg:oauth:2.0:oob","http://localhost"]}}
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            self.google_app = SocialApp.objects.create(
              provider="google",
              name="Google OAuth",
              client_id="514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com",
              secret="TgxYWFmND-1NTYwNTgzMDM3N",
            )
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            {
              "client_id": "514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com",
              "client_secret": "TgxYWFmND-1NTYwNTgzMDM3N",
              "refresh_token": "1/QzlJ1Z8CY_phper0QGxDqU8sZwy9ZH-hKs4ZSbke27k",
              "type": "authorized_user"
            }
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
              const char token_str[] =
                "{ \"client_id\": \"514233951460.apps.googleusercontent.com\","
                "  \"client_secret\": \"TgxYWFmND-1NTYwNTgzMDM3N\","
                "  \"refresh_token\": \"1/QzlJ1Z8CY_phper0QGxDqU8sZwy9ZH-hKs4ZSbke27k\","
                "  \"type\": \"authorized_user\"}";
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            "google" {
              "class" = "io.gearpump.services.security.oauth2.impl.GoogleOAuth2Authenticator"
              "callback" = "http://127.0.0.1:8090/login/oauth2/google/callback"
              "clientid" = "514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com"
              "clientsecret" = "TgxYWFmND-1NTYwNTgzMDM3N"
              "default-userrole" = "guest"
              icon = "/icons/google.png"
            }
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            OAUTH_CLIENT_ID=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.apps.googleusercontent.com
            OAUTH_CLIENT_SECRET=BBBBBBBBBBBBBBBBBBBBBBBB
          containsSecret: false
        - text: >
            GOOGLE_CLIENT_ID='sample_514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com'
            GOOGLE_CLIENT_SECRET='sample_ND-1NTYwNTgzMDM3N'
          containsSecret: false

    - id: google-oauth-secret-no-prefix-client-id-after
      metadata:
        name: Google OAuth client secrets should not be disclosed
      detection:
        matching:
          # "secret"
          # any text, containing up to 1 newline
          # the target client secret
          # any text, containing up to 3 newlines
          # ".apps.googleusercontent.com"
          pattern: "(?i)(?:secret(?:[^\\r\\n]*+\\r?\\n)?[^\\r\\n]+)\\b([A-Za-z0-9_\\-]{24})\\b(?:(?:[^\\r\\n]*+\\r?\\n){0,3}[^\\r\\n]*\\.apps\\.googleusercontent\\.com\\b)"
        post:
          patternNot: "(?i)sample|example|x{6}|0{6}"
          statisticalFilter:
            threshold: 4.0
      examples:
        - text: >
            client_secret: TgxYWFmND-1NTYwNTgzMDM3N
            client_id: 514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            GOOGLE_SECRET=TgxYWFmND-1NTYwNTgzMDM3N
            GOOGLE_ID=514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            # AUTH_OIDC_ENABLED=true
            # AUTH_OIDC_CLIENT_SECRET=TgxYWFmND-1NTYwNTgzMDM3N
            # AUTH_OIDC_CLIENT_ID=514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com
            # AUTH_OIDC_DISCOVERY_URI=https://accounts.google.com/.well-known/openid-configuration
            # AUTH_OIDC_BASE_URL=http://localhost:9000
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            {"installed":{"project_id":"example-project-12345","client_secret":"TgxYWFmND-1NTYwNTgzMDM3N","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://accounts.google.com/o/oauth2/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_id":"514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com","redirect_uris":["urn:ietf:wg:oauth:2.0:oob","http://localhost"]}}
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            {
              "type": "authorized_user",
              "client_secret": "TgxYWFmND-1NTYwNTgzMDM3N",
              "client_id": "514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com",
              "refresh_token": "1/QzlJ1Z8CY_phper0QGxDqU8sZwy9ZH-hKs4ZSbke27k"
            }
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            "google" {
              "class" = "io.gearpump.services.security.oauth2.impl.GoogleOAuth2Authenticator"
              "callback" = "http://127.0.0.1:8090/login/oauth2/google/callback"
              "clientsecret" = "TgxYWFmND-1NTYwNTgzMDM3N"
              "clientid" = "514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com"
              "default-userrole" = "guest"
              icon = "/icons/google.png"
            }
          containsSecret: true
          match: TgxYWFmND-1NTYwNTgzMDM3N
        - text: >
            OAUTH_CLIENT_ID=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.apps.googleusercontent.com
            OAUTH_CLIENT_SECRET=BBBBBBBBBBBBBBBBBBBBBBBB
          containsSecret: false
        - text: >
            GOOGLE_CLIENT_ID='sample_514233951460-ptar9o2diyaiz06uxa9inr2iuqjlvg1u.apps.googleusercontent.com'
            GOOGLE_CLIENT_SECRET='sample_ND-1NTYwNTgzMDM3N'
          containsSecret: false

    - id: google-oauth-js-client
      metadata:
        name: Google OAuth client secrets should not be disclosed
      detection:
        matching:
          # "new google.auth.OAuth2("
          # first parameter (client ID) is a quoted string ending in ".apps.googleusercontent.com"
          # optional "//" comment after the client ID
          # second parameter (client secret) is a quoted string
          pattern: "new\\s+google\\.auth\\.OAuth2\\(\\s*[\"'][a-z0-9\\-]+\\.apps\\.googleusercontent\\.com[\"']\\s*,\\s*+(?://[^\r\n]+\\s*+)?[\"']([A-Za-z0-9_\\-]{24})[\"']"
        post:
          patternNot: "(?i)sample|example|x{6}|0{6}"
          statisticalFilter:
            threshold: 4.0
      examples:


