provider:
  metadata:
    name: Azure 
    category: Cloud provider
    references:
      - description: OWASP Top 10 2021 Category A7 - Identification and Authentication Failures
        link:  https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/
        type: Standards
      - description: docs.microsoft.com - Manage storage account access keys
        link:  https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal
      - description: OWASP Top 10 2017 Category A3 - Sensitive Data Exposure
        link:  https://www.owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure
        type: Standards
      - description: MITRE, CWE-798 - Use of Hard-coded Credentials
        link:  https://cwe.mitre.org/data/definitions/798
        type: Standards
      - description: MITRE, CWE-259 - Use of Hard-coded Password
        link:  https://cwe.mitre.org/data/definitions/259
        type: Standards
      - description: SANS Top 25 - Porous Defenses
        link:  https://www.sans.org/top25-software-errors/#cat3
        type: Standards
    description: description.adoc
  modules:
    pre:
      include:
        - paths:
            - ".env"
            - ".*env*"
        - ext:
            - ".config"
        - content:
            - "azure"
            - "core.windows.net"
      reject:
        - paths: "*/tests?/*"
    post:
        - pattern-not: "EXAMPLE"

rules:
  - id: azure-storage-acount-key
    metadata:
      name: Azure Storage Account Keys should not be disclosed
      message: Make sure this Azure Storage Account Key gets revoked, changed, and removed from the code.
      impact: azure-storage-account.adoc
    examples:
      - text: >
          async function main() {
            const account = process.env.ACCOUNT_NAME || "accountname";
            const accountKey = process.env.ACCOUNT_KEY || "4dVw+l0W8My+FwuZ08dWXn+gHxcmBtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==";
            const sharedKeyCredential = new StorageSharedKeyCredential(account, accountKey);
            const blobServiceClient = new BlobServiceClient(
              `https://${account}.blob.core.windows.net`,
              sharedKeyCredential
            );
          }
        match: 4dVw+l0W8My+FwuZ08dWXn+gHxcmBtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==
      - text: >
          const connStr = "DefaultEndpointsProtocol=https;AccountName=testaccountname;AccountKey=4dVw+l0W8My+FwuZ08dWXn+gHxcmBtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==";
        match: 4dVw+l0W8My+FwuZ08dWXn+gHxcmBtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==
      - text: >
          AccountKey = "BtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==";
        match: false
      - text: >
          const connStr = "DefaultEndpointsProtocol=https;AccountName=testaccountname;AccountKey=4dVw+l0W8My+FwuZ08dWXn+gHxcmBtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==;EndpointSuffix=core.windows.net";
        match: 4dVw+l0W8My+FwuZ08dWXn+gHxcmBtS7esLAQSrm6/Om3jeyUKKGMkfAh38kWZlItThQYsg31v23A0w/uVP4pg==
    modules:
      matching:
        match-either:
         - pattern: "['\"`]([a-zA-Z0-9/\\+]{86}==)['\"`]"
         - pattern: "AccountKey=([a-zA-Z0-9/\\+]{86}==)"
